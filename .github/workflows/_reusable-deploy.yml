name: codexctl-deploy

on:
  workflow_call:
    inputs:
      env:
        required: true
        type: string
        description: "Target environment name (e.g. dev, staging, ai)"
      namespace:
        required: false
        type: string
        description: "Namespace override (normally derived from services.yaml patterns)"
      ref:
        required: false
        type: string
        description: "Git ref of the consumer repository to deploy (branch/tag/SHA)"
      code_root_base:
        required: false
        type: string
        description: "Host path with synced sources for slot-based environments (used in hostPath mounts)"
      vars:
        required: false
        type: string
        description: "Additional variables in k=v,k2=v2 format"
      var_file:
        required: false
        type: string
        description: "Path to var-file in the consumer repo"
      slot:
        required: false
        type: number
        description: "Slot number for slot-based environments (e.g. ai)"
    secrets:
      KUBECONFIG:
        required: true
        description: "Kubeconfig content or path for kubectl"
      CODEX_GH_PAT:
        required: true
        description: "GitHub personal access token for codexctl and hooks"
      CODEX_GH_USERNAME:
        required: false
      OPENAI_API_KEY:
        required: false
      CONTEXT7_API_KEY:
        required: false

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with:
          # Allow caller to override ref; otherwise use event ref/SHA.
          ref: ${{ inputs.ref != '' && inputs.ref || github.sha }}
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: Checkout codexctl (same ref as this reusable workflow)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.action_repository }}
          ref: ${{ github.action_ref }}
          path: ./.codexctl
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: Build codexctl
        run: |
          set -euo pipefail
          cd ./.codexctl
          go build -o ../codexctl ./cmd/codexctl

      - name: Render and apply stack via codexctl
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          CODEX_GH_PAT: ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME: ${{ secrets.CODEX_GH_USERNAME }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
          CODE_ROOT_BASE: ${{ inputs.code_root_base }}
        run: |
          set -euo pipefail

          ENV_NAME="${{ inputs.env }}"
          NS_INPUT="${{ inputs.namespace }}"
          VARS_INPUT="${{ inputs.vars }}"
          VAR_FILE_INPUT="${{ inputs.var_file }}"
          SLOT_INPUT="${{ inputs.slot }}"

          ARGS=(apply --env "${ENV_NAME}" --wait --preflight)

          if [ -n "$NS_INPUT" ]; then
            ARGS+=(--namespace "$NS_INPUT")
          fi
          if [ -n "$VARS_INPUT" ]; then
            ARGS+=(--vars "$VARS_INPUT")
          fi
          if [ -n "$VAR_FILE_INPUT" ]; then
            ARGS+=(--var-file "$VAR_FILE_INPUT")
          fi
          if [ -n "$SLOT_INPUT" ] && [ "$SLOT_INPUT" != "0" ]; then
            ARGS+=(--slot "$SLOT_INPUT")
          fi

          ./codexctl "${ARGS[@]}"
