name: codexctl-ai-codex-run

on:
  workflow_call:
    inputs:
      env:
        required: false
        type: string
        default: "ai"
        description: "Environment for Codex run (default: ai)"
      slot:
        required: true
        type: number
        description: "Allocated slot number for the AI environment"
      issue:
        required: false
        type: number
        description: "GitHub issue number associated with this run"
      pr:
        required: false
        type: number
        description: "GitHub pull request number associated with this run"
      kind:
        required: false
        type: string
        default: "dev_issue"
        description: "Builtin prompt kind (dev_issue or review_fix)"
      lang:
        required: false
        type: string
        default: "en"
        description: "Prompt language code (en, ru, ...)"
      vars:
        required: false
        type: string
        description: "Additional variables in k=v,k2=v2 format"
      var_file:
        required: false
        type: string
        description: "Path to var-file in the consumer repo"
    secrets:
      KUBECONFIG:
        required: true
      CODEX_GH_PAT:
        required: true
      CODEX_GH_USERNAME:
        required: true
      OPENAI_API_KEY:
        required: true
      CONTEXT7_API_KEY:
        required: false

jobs:
  run:
    runs-on: self-hosted

    steps:
      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: Checkout codexctl (same ref as this reusable workflow)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.action_repository }}
          ref: ${{ github.action_ref }}
          path: ./.codexctl
          token: ${{ secrets.CODEX_GH_PAT }}

      - name: Build codexctl
        run: |
          set -euo pipefail
          cd ./.codexctl
          go build -o ../codexctl ./cmd/codexctl

      - name: Run Codex agent via codexctl
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          CODEX_GH_PAT: ${{ secrets.CODEX_GH_PAT }}
          CODEX_GH_USERNAME: ${{ secrets.CODEX_GH_USERNAME }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
        run: |
          set -euo pipefail

          ENV_NAME="${{ inputs.env }}"
          SLOT="${{ inputs.slot }}"
          ISSUE="${{ inputs.issue }}"
          PR="${{ inputs.pr }}"
          KIND="${{ inputs.kind }}"
          LANG="${{ inputs.lang }}"
          VARS_INPUT="${{ inputs.vars }}"
          VAR_FILE_INPUT="${{ inputs.var_file }}"

          ARGS=(prompt run --env "${ENV_NAME}" --slot "${SLOT}" --kind "${KIND}" --lang "${LANG}")

          if [ -n "$ISSUE" ] && [ "$ISSUE" != "0" ]; then
            ARGS+=(--issue "$ISSUE")
          fi
          if [ -n "$PR" ] && [ "$PR" != "0" ]; then
            ARGS+=(--pr "$PR")
          fi
          if [ -n "$VARS_INPUT" ]; then
            ARGS+=(--vars "$VARS_INPUT")
          fi
          if [ -n "$VAR_FILE_INPUT" ]; then
            ARGS+=(--var-file "$VAR_FILE_INPUT")
          fi

          ./codexctl "${ARGS[@]}"
