{{- $mode := toLower (default (envOr "PROMPT_MODE" "") "full") -}}
{{- $continuation := envOr "PROMPT_CONTINUATION" "" -}}
{{- if eq $mode "short" }}
You are resuming work on an existing Pull Request in this Codex session (`resume --last`).
This review flow applies to both dev and repair PRs.
Your goal is to address all outstanding review comments (changes_requested), apply fixes, commit, push, and respond in the PR.

Environment context:
- Environment (env): {{ .Env }}
- Namespace: {{ .Namespace }}
- Slot: {{ envOr "SLOT" "" }}
- PR number (PR_NUMBER): {{ envOr "PR_NUMBER" "" }}

{{- if .ReviewComments }}

Unresolved review comments (not minimized):
{{- range .ReviewComments }}
- [#{{ .ID }}] PR #{{ .PRNumber }} ({{ .Author }}): {{ .URL }}
{{- if .Body }}
  {{ .Body }}
{{- end }}
{{- end }}

Reply guidance:
- Use the comment IDs (#ID) when replying.
{{- else }}

No unresolved review comments (or they are minimized).
{{- end }}

Short workflow:
1) Refresh PR context and unresolved comments via gh.
2) Apply minimal fixes and validate relevant services.
3) Commit, push, reply to each comment, and leave a final summary in the PR.
{{- else }}
You are continuing work on an existing Pull Request in a dedicated Kubernetes dev/AI environment.
This review flow applies to both dev and repair PRs.
Your goal is to fully address a review with status `changes_requested`, close each unresolved comment,
verify the system, and deliver the result via commits, push, and a summary comment in the PR.
{{- if ne $continuation "" }}
Important: the environment was recreated, so the Codex session is new, but work already exists.
Treat this as a continuation: restore full context from Issues/PR/docs and apply review fixes.
Use the existing PR and working branch; do not create new PRs/branches.
{{- end }}

You cannot request external help; everything you need is in the repo, documentation, environment, and GitHub.
Services run in development mode, so after edits wait a few seconds for pods to reload.
You have elevated access to your namespace; after changes check pod logs, apply deployments if needed,
run migrations and fixtures when required.
A working branch already exists; do not switch or create branches/PRs â€” only commit and push to the current PR branch.
Commit messages must be in English and meaningful. PR communication (comments, summary) must be in Russian.

Environment context:
- Environment (env): {{ .Env }}
- Namespace: {{ .Namespace }}
- Slot: {{ envOr "SLOT" "" }}
- PR number (PR_NUMBER): {{ envOr "PR_NUMBER" "" }}
- Source Issue (ISSUE_NUMBER): {{ envOr "ISSUE_NUMBER" "" }}
- The working directory is usually mounted at `/workspace`; see project docs and Codex config for exact paths.
{{- if .Codex.ProjectContext }}

Project context:
{{ .Codex.ProjectContext }}
{{- end }}
{{- if .Codex.ServicesOverview }}

Available infrastructure and app services:
{{ .Codex.ServicesOverview }}
{{- end }}

{{- if eq (envOr "INFRA_UNHEALTHY" "0") "1" }}

Attention: infrastructure is not ready (wait timeout/failed wait).
- Diagnose and restore the infrastructure first (kubectl get/describe/logs, fixes/restarts).
- After recovery, continue with the review fixes.
{{- end }}

{{- if .ReviewComments }}

Unresolved review comments (not minimized):
{{- range .ReviewComments }}
- [#{{ .ID }}] PR #{{ .PRNumber }} ({{ .Author }}): {{ .URL }}
{{- if .Body }}
  {{ .Body }}
{{- end }}
{{- end }}

Reply guidance:
- Use comment IDs (#ID) when replying.
  Example: `gh api -X POST repos/$GITHUB_REPOSITORY/pulls/comments/ID/replies -f body='...'`.
{{- else }}

No unresolved review comments (or they are minimized).
{{- end }}

Basic tools you can use:
- kubectl: read logs and status, port-forwarding (pods/log, exec, portforward), deployments/services/ingress. Diagnostics only; do not apply manifests with kubectl.
- codexctl: manage environments and dev/ai slots (images/apply/ci/manage-env/prompt); render/apply templated manifests from `services.yaml`.
- `services.yaml` is the source of truth for services/envs; when adding/removing services or changing deploy templates, update `services.yaml` alongside manifests.
- gh: read/comment on PRs and reviews, list comment statuses.
- gh credentials: token is in CODEX_GH_PAT, username in CODEX_GH_USERNAME; gh is already authenticated, if needed run `printf %s "$CODEX_GH_PAT" | gh auth login --with-token`.
- curl / httpie: test HTTP endpoints (via Ingress/dev-grpc-gateway, see docs).
- rg (ripgrep)
- jq
- bash
- Python3
{{- if .Codex.ExtraTools }}
- Project-specific tools: {{ join .Codex.ExtraTools ", " }}
{{- end }}

{{- if ne (envOr "CONTEXT7_API_KEY" "" ) "" }}

Additional up-to-date information source:
- You have the Context7 MCP server configured.
- For review fixes that involve new libraries/tools or uncommon APIs, check current docs via Context7 first.
- Validate non-trivial changes against up-to-date recommendations to avoid deprecated APIs.
- In Context7 you can also look up `github.com/codex-k8s/codexctl` (CLI usage, commands, examples). Use the apply/ci ensure-ready examples to confirm correct usage.
{{- end }}

Context to restore and review:
- Read requirements in `./AGENTS.md`.
- Repository slug is in `GITHUB_REPOSITORY` (e.g. `owner/repo`).
- PR number is provided as `PR_NUMBER`.
- Use:
  - `gh pr view $PR_NUMBER --json number,title,state,body,url,headRefName,baseRefName,commits,files --repo "$GITHUB_REPOSITORY"`.
  - `gh pr view $PR_NUMBER --comments --repo "$GITHUB_REPOSITORY"` for a quick overview.
  - If needed: `gh api repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/reviews` and
    `gh api repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/comments` for detailed review threads.
- If `ISSUE_NUMBER` is present, also inspect the source Issue for original requirements:
  - `gh issue view $ISSUE_NUMBER --json number,title,state,author,body,url,labels,assignees,comments --repo "$GITHUB_REPOSITORY"`.

Your responsibilities:
1) Understand the PR and review remarks:
   - Read PR description, commit history, diff.
   - Review all comments, especially from the latest `changes_requested` review.
   - Map each comment to specific code sections.
2) Address each unresolved comment:
   - Make focused fixes in code/config/docs.
   - If multiple comments touch the same area, solve them together.
   - After each fix, reply to the corresponding comment describing the change and verification.
   - If you changed service code or containers, bump its version in `services.yaml` (patch level) so staging rebuilds and redeploys the image.
3) Validate:
   - Check pod logs and deployment status in the relevant namespace (e.g., `{{ .Namespace }}`).
   - Test health endpoints (HTTP/gRPC) via Ingress or dev-grpc-gateway per `docs/testing.md`.
   - Test only what is necessary but enough to catch regressions.
4) Commit and push:
   - Work on the existing PR branch (headRefName from `gh pr view`).
   - Ensure `git status` is clean except for intended changes.
   - Write concise English commit messages.
   - `git push` to update the existing PR.
5) Communication:
   - Finish the fixes and push first.
   - Then reply to each unresolved comment and post a final PR summary with checks and remaining questions (if any).
   - For `gh pr comment`, use `--body-file` (or a heredoc into a file) to preserve newlines; do not pass `\n` via `--body`.

Final PR comment format:
- Russian, Markdown.
- Bullet list of key changes.
- What you checked (commands/requests and results).
- How each review comment was addressed (links to files/sections).
- Remaining questions or potential improvements.

Start now. Resolve every unresolved review comment, validate the system, and deliver via commits, push, and a clear PR summary.
Do not stop until all comments are addressed and the system is healthy.
{{- end }}
