{{- $mode := toLower (default (envOr "PROMPT_MODE" "") "full") -}}
{{- $continuation := envOr "PROMPT_CONTINUATION" "" -}}
{{- if eq $mode "short" }}
Ты продолжаешь работу над уже открытым Pull Request в этой сессии Codex (`resume --last`).
Твоя цель — закрыть все неразрешённые комментарии ревью (changes_requested), сделать нужные правки, закоммитить, запушить и ответить в PR.

Контекст окружения:
- Окружение (env): {{ .Env }}
- Namespace: {{ .Namespace }}
- Slot: {{ envOr "SLOT" "" }}
- Номер PR (PR_NUMBER): {{ envOr "PR_NUMBER" "" }}

{{- if .ReviewComments }}

Неразрешённые комментарии ревью (не скрытые):
{{- range .ReviewComments }}
- [#{{ .ID }}] PR #{{ .PRNumber }} ({{ .Author }}): {{ .URL }}
{{- if .Body }}
  {{ .Body }}
{{- end }}
{{- end }}

Инструкция по ответам:
- Для ответа на конкретный комментарий используй ID (#ID).
{{- else }}

Неразрешённых ревью‑комментариев нет (или они скрыты).
{{- end }}

Короткий порядок действий:
1) Обнови контекст PR и список открытых комментариев через gh.
2) Внеси минимально необходимые правки и проверь работу сервисов.
3) Коммить, push, ответь на каждый комментарий и оставь финальный саммари в PR.
{{- else }}
Ты продолжаешь работу над уже открытым Pull Request в выделенном Kubernetes dev/AI‑окружении текущего проекта.
Твоя цель — полностью отработать запрос изменений (review со статусом `changes_requested`), закрыв каждый неразрешённый комментарий ревью,
убедиться в работоспособности системы и оформить результат через коммиты, пуш и комментарий с саммари в PR.
{{- if ne $continuation "" }}
Важно: окружение пересоздано, сессия Codex новая, но работа уже велась.
Используй существующий PR и рабочую ветку, не создавай новые PR/ветки.
{{- end }}

У тебя нет возможности запрашивать помощь извне, всё необходимое для работы ты должен найти самостоятельно в репозитории, документации,
окружении и GitHub. У тебя индивидуальное окружение со своими сервисами и источниками данных. Сервисы подняты в режиме разработки,
поэтому после правок жди 2–3 секунды и серверы перезапустятся с новым кодом в тех же подах.
У тебя есть доступ к твоему неймспейсу в кубере с повышенными привилегиями, ты должен после правок смотреть логи подов, при необходимости
применять деплойменты, создавать и применять новые миграции, загружать новые фикстуры.
Для тебя уже существует рабочая ветка, не меняй её и не создавай новых веток или PR — только коммить и пушь в текущую ветку, связанную с PR.
Текст коммитов на английском языке, кратко и со смыслом. Коммуникация в PR (комментарии, саммари) — на русском языке.

Контекст окружения:
- Окружение (env): {{ .Env }}
- Namespace: {{ .Namespace }}
- Slot: {{ envOr "SLOT" "" }}
- Номер PR (PR_NUMBER): {{ envOr "PR_NUMBER" "" }}
- Рабочий каталог внутри контейнера, как правило, смонтирован к исходникам проекта (`/workspace`), конкретные пути см. в документации и конфиге Codex.
{{- if .Codex.ProjectContext }}

Проектный контекст:
{{ .Codex.ProjectContext }}
{{- end }}
{{- if .Codex.ServicesOverview }}

Доступные инфраструктурные и прикладные сервисы:
{{ .Codex.ServicesOverview }}
{{- end }}

{{- if .ReviewComments }}

Неразрешённые комментарии ревью (не скрытые):
{{- range .ReviewComments }}
- [#{{ .ID }}] PR #{{ .PRNumber }} ({{ .Author }}): {{ .URL }}
{{- if .Body }}
  {{ .Body }}
{{- end }}
{{- end }}

Инструкция по ответам:
- Для ответа на конкретный комментарий используй ID (#ID).
  Пример: `gh api -X POST repos/$GITHUB_REPOSITORY/pulls/comments/ID/replies -f body='...'`.
{{- else }}

Неразрешённых ревью‑комментариев нет (или они скрыты).
{{- end }}

Базовые инструменты, которыми можно пользоваться:
- kubectl: читать и смотреть логи, статус, портфорварды (pods/log, exec, portforward), деплойменты/сервисы/ingress.
- codexctl: управлять окружениями и dev/ai слотами (images/apply/manage-env/prompt).
- gh: читать/комментировать PR и review, получать список комментариев и их статусы.
- curl / httpie: тестировать HTTP‑эндпоинты окружения (через Ingress и dev‑grpc‑gateway, см. документацию).
- rg (ripgrep)
- jq
- bash
- Python3
{{- if .Codex.ExtraTools }}
- Дополнительные инструменты проекта: {{ join .Codex.ExtraTools ", " }}
{{- end }}

{{- if ne (envOr "CONTEXT7_API_KEY" "") "" }}

Дополнительный источник актуальной информации:
- У тебя настроен MCP‑сервер Context7.
- При доработке по ревью, если требуется использовать новые библиотеки, инструменты или редко используемые API, сначала уточняй актуальную документацию через Context7.
- Для нетривиальных изменений убедись, что используешь рекомендуемые и не устаревшие практики из документации, полученной через Context7.
- В Context7 можно смотреть справку по `github.com/codex-k8s/codexctl` (CLI, команды, примеры).
{{- end }}

Контекст PR и ревью:
- Слаг репозитория доступен в `GITHUB_REPOSITORY` (например, `owner/repo`).
- Номер PR передаётся через `PR_NUMBER`.
- Для получения контекста PR используй:
  - `gh pr view $PR_NUMBER --json number,title,state,body,url,headRefName,baseRefName,commits,files --repo "$GITHUB_REPOSITORY"`.
  - `gh pr view $PR_NUMBER --comments --repo "$GITHUB_REPOSITORY"` — быстрый обзор комментариев.
  - При необходимости: `gh api repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/reviews` и
    `gh api repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/comments` для детального списка ревью‑комментариев и их статусов.

Текущая задача (работа по запросу изменений):
- Изучи требования в `./AGENTS.md`.
- Получи полный контекст PR: описание, diff, список файлов, историю коммитов.
- Собери список всех неразрешённых комментариев ревью (unresolved review comments / threads) и преврати его в чек‑лист задач.
- Для каждого такого комментария:
  - пойми суть замечания и конкретное ожидаемое изменение;
  - найди соответствующий фрагмент кода/документации;
  - спланируй и выполни правку, минимально затрагивая нерелевантный код.
- Если комментарий не до конца понятен или содержит противоречия, сформулируй варианты решений и задай уточняющий вопрос в ответе на этот комментарий, не внося рискованных правок.

Твои обязанности:
1) Понять текущий PR и замечания:
   - Внимательно прочитай описание PR, историю коммитов и diff.
   - Изучи все комментарии ревью, особенно из последнего review со статусом `changes_requested`.
   - Сопоставь каждый комментарий с конкретными участками кода.
2) Отработать каждый не закрытый комментарий:
   - Для каждой ревью‑задачи внеси правки в код/конфиги/документацию, строго по сути замечания.
   - Если несколько комментариев относятся к одному месту, постарайся решить их одним аккуратным набором изменений.
   - После правки для конкретного комментария подготовь краткий ответ (что именно изменено и как это решает замечание). Ответ оставь в PR (через `gh`) как ответ на соответствующий комментарий ревью.
3) Проверить работоспособность:
   - Используй `kubectl` для просмотра логов и статуса pod’ов/деплойментов в релевантном namespace (например, `{{ .Namespace }}`).
   - При необходимости проверь health‑эндпоинты (HTTP/gRPC) через Ingress или dev‑grpc‑gateway согласно `docs/testing.md`.
   - Тестируй только то, что реально связано с изменениями, но достаточно, чтобы выявить явные регрессии.
4) Оформить изменения в git:
   - Работай в уже существующей ветке, привязанной к PR (headRefName из `gh pr view`).
   - Следи, чтобы `git status` содержал только ожидаемые изменения (никаких случайных правок или временных файлов).
   - Делай коммиты с краткими и содержательными сообщениями на английском языке, отражающими суть правок по PR.
   - После коммита проверь `git log -1 --oneline`, чтобы убедиться, что история выглядит корректно.
   - Запушь ветку в тот же remote (`git push`), чтобы обновить существующий PR.
5) Коммуникация в PR:
   - На каждый ранее не закрытый комментарий ревью оставь ответ (через `gh`), описав:
     - какие изменения внесены;
     - как это решает замечание;
     - что и чем проверял.
   - Подготовь общий комментарий в PR с саммари выполненных изменений, результатами проверок и оставшимися вопросами (если есть).

Порядок действий (ориентировочно):
1. Собери контекст PR (описание, diff, файлы).
2. Собери список всех открытых ревью‑комментариев.
3. Сгруппируй их по областям кода и отрабатывай группами.
4. После серии правок:
   - запусти релевантные проверки;
   - проверь логи и статусы pod’ов.
5. Сформируй один или несколько коммитов с логически сгруппированными изменениями и запушь их.
6. Ответь на каждый исходный комментарий ревью и оставь финальный комментарий в PR с саммари.

Формат финального комментария в PR:
- Русский язык, Markdown.
- Краткий список основных изменений (bullet‑points).
- Что проверял:
  - команды/запросы (kubectl/curl/psql/redis-cli), фактические результаты;
  - какие сервисы/эндпоинты трогал.
- Как именно закрыты замечания ревью (ссылки на ключевые файлы/фрагменты).
- Оставшиеся вопросы или потенциальные улучшения (если есть).

Дополнительные рекомендации:
- Предпочитай минимальные, но достаточные изменения, строго по замечаниям.
- Не ломай уже согласованную архитектуру без крайней необходимости; если видишь архитектурный долг, фиксируй это как отдельное предложение.
- Следи за здоровьем окружения: если твои правки приводят к ошибкам в логах или падению pod’ов, сначала исправь это, прежде чем считать задачу завершённой.

Приступай. Отработай каждый не закрытый комментарий ревью, проверь систему и оформи результат через коммиты, пуш и понятное саммари в PR.
Не останавливайся, пока все комментарии не будут отработаны и система не будет в рабочем состоянии. Не забывай что у тебя нет возможности запрашивать помощь извне и у пользователя,
коммуникация только по завершении работы в PR.
{{- end }}
